@{
    ViewData["Title"] = "Invoice";
}

<div class="animate-fade-in">
    <!-- Modern Page Header -->
    <div class="page-header mb-6">
        <div class="relative z-10 flex items-center gap-4">
            <a asp-action="Index" class="btn btn-circle btn-ghost">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-file-invoice text-2xl text-primary"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-base-content"><span id="pageTitle"></span></h1>
                    <p class="text-base-content/70 mt-1">Create and manage invoices for tours</p>
                </div>
            </div>
        </div>
    </div>

    <form id="invoiceForm">
        <input type="hidden" id="id" />

        <!-- Basic Information Card -->
        <div class="section-modern mb-6">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-info-circle text-lg text-primary"></i>
                </div>
                <h2 class="font-bold text-lg">Basic Information</h2>
            </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Date</span>
                        </label>
                        <input type="text" class="input input-bordered bg-base-200" id="date" disabled />
                    </div>

                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-semibold">Dr. <span class="text-error">*</span></span>
                        </label>
                        <input type="text" class="input input-bordered" name="dr" id="dr" placeholder="Recipient" />
                        <label class="label">
                            <span class="label-text-alt text-error" id="dr-error"></span>
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Currency <span class="text-error">*</span></span>
                        </label>
                        <input type="text" class="input input-bordered" name="currency" id="currency"
                               placeholder="USD" oninput="this.value = this.value.toUpperCase()" maxlength="3" />
                        <label class="label">
                            <span class="label-text-alt text-error" id="currency-error"></span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Reference No.</span>
                        </label>
                        <input type="text" class="input input-bordered" name="referenceNo" id="referenceNo" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">File Code No.</span>
                        </label>
                        <input type="text" class="input input-bordered" name="fileCodeNo" id="fileCodeNo" />
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3 border border-base-300 rounded-lg px-4 py-3">
                            <input type="checkbox" name="isTicket" id="isTicket" class="checkbox checkbox-primary" />
                            <span class="label-text font-semibold">Is Ticket?</span>
                        </label>
                    </div>
                </div>
        </div>

        <!-- Client Information Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-4">
                    <i class="fas fa-user text-primary"></i>
                    Client Information
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Client Name <span class="text-error">*</span></span>
                        </label>
                        <input type="text" class="input input-bordered" name="clientName" id="clientName" />
                        <label class="label">
                            <span class="label-text-alt text-error" id="clientName-error"></span>
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Address</span>
                        </label>
                        <input type="text" class="input input-bordered" name="address" id="address" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">PAX</span>
                        </label>
                        <input type="number" class="input input-bordered" name="pax" id="pax" min="0" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Guide</span>
                        </label>
                        <input type="text" class="input input-bordered" name="guide" id="guide" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Vehicle</span>
                        </label>
                        <input type="text" class="input input-bordered" name="vehicle" id="vehicle" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Items Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-4">
                    <i class="fas fa-list text-primary"></i>
                    Invoice Items
                </h2>

                <!-- Add Item Section -->
                <div class="bg-base-200 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control md:col-span-2">
                            <input type="text" class="input input-bordered" id="particulars"
                                   placeholder="Description of service or item" />
                        </div>

                        <div class="form-control">
                            <div class="join w-full">
                                <input type="number" class="input input-bordered join-item flex-1"
                                       id="particularAmount" placeholder="0.00" step="0.01" min="0" />
                                <button type="button" class="btn btn-primary join-item" id="addProduct">
                                    <i class="fas fa-plus"></i>
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items Table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>Particulars</th>
                                <th class="text-right">Amount</th>
                                <th class="text-center w-24">Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td colspan="3" class="text-center py-8 text-base-content/50">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p>No items added yet</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Totals Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-4">
                    <i class="fas fa-calculator text-primary"></i>
                    Totals
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Total Due</span>
                        </label>
                        <input type="text" class="input input-bordered input-lg bg-base-200 font-bold text-xl" id="totalDue" disabled />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Discount</span>
                        </label>
                        <input type="number" class="input input-bordered input-lg" name="discount" id="discount"
                               placeholder="0.00" step="0.01" min="0" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Net Amount</span>
                        </label>
                        <input type="text" class="input input-bordered input-lg bg-success text-success-content font-bold text-xl"
                               id="netAmount" disabled />
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4 justify-end">
            <a asp-action="Index" class="btn btn-ghost btn-lg">
                <i class="fas fa-times"></i>
                Cancel
            </a>
            <button type="submit" class="btn btn-primary btn-lg" id="btnSave">
                <i class="fas fa-save"></i>
                Save Invoice
            </button>
        </div>
    </form>
</div>

<!-- View/Print Invoice Modal -->
<dialog id="viewInvoice" class="modal">
    <div class="modal-box max-w-6xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
        </form>
        <h3 class="font-bold text-lg mb-4">Invoice</h3>

        <div id="invoiceBody" class="overflow-auto max-h-[70vh] bg-white p-4">
            <div id="receiptTemplate"></div>
        </div>

        <div class="modal-action">
            <button type="button" class="btn btn-error" id="printInvoice">
                <i class="fas fa-print mr-2"></i>
                Print
            </button>
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>

@section Scripts {
    <script src="~/lib/handlebars/handlebars.min.js"></script>
    <script src="~/lib/html2canvas/html2canvas.min.js"></script>
    <script src="~/js/invoice.js"></script>
    <script>
        // Set up form for Add/Edit
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const invoiceId = urlParams.get('id');

            if (invoiceId) {
                $('#pageTitle').text('Edit Invoice');
                // Load invoice data via editInvoice function
                editInvoice(parseInt(invoiceId));
            } else {
                $('#pageTitle').text('New Invoice');
            }
        });
    </script>
    <script id="entry-template" type="text/x-handlebars-template">
        <style>
            #page { border-collapse: collapse; border: 2px solid; font-family: Arial, Helvetica, sans-serif; }
            #page td { padding-top: 1px; margin: 0; font-size: 22px; border-right: 2px solid; }
            #page th { border-right: 2px solid; border-bottom: 2px solid; }
            #page tfoot { border-top: 2px solid; }
            .topRightInfo { padding-left: 6rem; }
            .topRightInfo h6 { margin-bottom: 1px; font-size:19px; }
            body h6 { font-size:24px; }
            span { font-weight: bold; }
        </style>

        <div class="row">
            <div class="col-md-8">
                <img src="~/img/logo2.jpg" style="max-width:100%; max-height:80%" />
            </div>
            <div class="col-md-4 topRightInfo">
                <h6>GPO Box: 9484</h6>
                <h6>Lazimpat - 2, Kathmandu, Nepal</h6>
                <h6>Tel: (977) 01 4444843/44/45</h6>
                <h6>Email: peaceintl.mail@@gmail.com</h6>
                <h6>&emsp;&emsp;&emsp;mail@@peace-intl.com.np </h6>
                <h6>Web: peace-intl.com </h6>
                <h6>PAN: 302243385 </h6>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <h6>Dr:&emsp;<span>{{invoice.dr}}</span></h6>
                <h6>&emsp;&emsp;&emsp;<span>{{invoice.address}}</span></h6>
                <h6>Ref No:&emsp;{{invoice.referenceNo}}</h6>
                <h6>Name:&emsp;<span>{{invoice.clientName}} X {{invoice.pax}} PAX</span></h6>
            </div>
            <div class="col-md-4" style="padding-left:6rem;">
                <h6>Date:&emsp;<span>{{chain "splitDate" "customDate" invoice.createdDate}}</span></h6>
                <h6>Invoice no:&emsp;{{invoice.invoiceNo}}</h6>
                <h6>File Code No:&emsp;{{invoice.fileCodeNo}}</h6>
                <h6>Currency:&emsp;<span>{{invoice.currency}}</span></h6>
            </div>
        </div>
        <br />
        <h6 class="text-center font-weight-bold">Your Account has been debited as per particulars given below:</h6>
        <div class="row flex-nowrap">
            <table class="table table-borderless ml-2 mr-2" id="page">
                <thead class="text-center thead-light">
                    <tr>
                        <th width="5%">SN.</th>
                        <th width="70%">PARTICULARS</th>
                        <th width="20%">AMOUNT</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each invoiceDetail}}
                    <tr>
                        <td height="40" align="center">{{inc @@index}}</td>
                        <td height="40">{{this.particulars}}</td>
                        <td height="40" class="text-right pr-5">{{distanceFixed this.amount}}</td>
                    </tr>
                    {{/each}}
                    {{#for invoiceDetail.length 18 1}}
                    <tr>
                        <td height="40"></td>
                        <td height="40"></td>
                        <td height="40"></td>
                    </tr>
                    {{/for}}
                </tbody>
                <tfoot>
                    <tr style="border-bottom:2px solid;">
                        <td colspan="2" align="right" class="font-weight-bold">Total Due:</td>
                        <td align="right" class="pr-5">{{distanceFixed invoice.totalDue}}</td>
                    </tr>
                    <tr style="border-bottom:2px solid;">
                        <td colspan="2" align="right" class="font-weight-bold">Discount:</td>
                        <td align="right" class="pr-5">{{distanceFixed invoice.discount}}</td>
                    </tr>
                    <tr style="border-bottom:2px solid;">
                        <td colspan="2" align="right" class="font-weight-bold">Net Amount:</td>
                        <td align="right" class="pr-5">{{distanceFixed invoice.netAmount}} </td>
                    </tr>
                    <tr>
                        <td colspan="3"><span>In Words:</span> {{inWords invoice.netAmount}}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="row">
            <div class="col-md-3">
                <h6>E. & O. E.</h6>
                <h6>ENCLOSURES: </h6>
                <h6>Prepared By: </h6>
                <h6>Checked By:</h6>
            </div>
            <div class="col-md-9">
                <h6 class="font-weight-bold float-right">For : Peace International Tours & Travel (P) Ltd</h6>
                <br /><br />
                <h6 class="float-right mr-5">{{userName}}</h6>
                <br /><br />
                <h6 class="border-top border-dark float-right">Authorized Signature: </h6>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 text-center">
                <br />
                <h6>
                    IMPORTANT : 1. If the Payment is to be made through Bank, transfer kindly made it directly either at our <br>A/C No. 01 04 21 7500056 at Nabil Bank, Kantipath, Kathmandu under advise to us.
                </h6>
            </div>
        </div>
    </script>
}
