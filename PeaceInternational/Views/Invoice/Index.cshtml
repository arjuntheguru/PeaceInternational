@{
    ViewData["Title"] = "Invoice";
}

<div class="animate-fade-in">
    <!-- Modern Page Header -->
    <div class="page-header">
        <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
                        <i class="fas fa-file-invoice-dollar text-2xl text-primary"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-base-content">Invoice Management</h1>
                        <p class="text-base-content/70 mt-1">Create and manage client invoices</p>
                    </div>
                </div>
            </div>
            <a asp-action="AddEdit" class="btn btn-accent btn-lg gap-2 shadow-lg hover:scale-105 transition-transform">
                <i class="fas fa-plus"></i>
                New Invoice
            </a>
        </div>
    </div>

    <!-- Search Filters -->
    <div class="bg-base-200 rounded-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Invoice No.</span>
                </label>
                <label class="input flex items-center gap-2 bg-base-100">
                    <i class="fas fa-hashtag text-base-content/40"></i>
                    <input type="text" id="searchField" placeholder="Search..." class="grow" />
                </label>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">File Code</span>
                </label>
                <label class="input flex items-center gap-2 bg-base-100">
                    <i class="fas fa-file-code text-base-content/40"></i>
                    <input type="text" id="searchFieldFileCode" placeholder="Search..." class="grow" />
                </label>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Client Name</span>
                </label>
                <label class="input flex items-center gap-2 bg-base-100">
                    <i class="fas fa-user text-base-content/40"></i>
                    <input type="text" id="searchFieldClient" placeholder="Search..." class="grow" />
                </label>
            </div>
        </div>
    </div>

    <!-- Invoice Table -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full" id="invoiceTable">
                    <thead class="bg-primary text-primary-content">
                        <tr>
                            <th class="normal-case text-base">Invoice No.</th>
                            <th class="normal-case text-base">File Code</th>
                            <th class="normal-case text-base">Client Name</th>
                            <th class="normal-case text-base">Currency</th>
                            <th class="normal-case text-base text-right">Net Amount</th>
                            <th class="normal-case text-base text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="text-center py-12">
                                <div class="loading loading-spinner loading-lg text-primary"></div>
                                <p class="mt-4">Loading invoices...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- View/Print Invoice Modal -->
<dialog id="viewInvoice" class="modal">
    <div class="modal-box max-w-6xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
        </form>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                <i class="fas fa-file-invoice text-lg text-primary"></i>
            </div>
            <h3 class="font-bold text-2xl">Invoice Preview</h3>
        </div>

        <div id="invoiceBody" class="overflow-auto max-h-[70vh] bg-white">
            <div id="receiptTemplate"></div>
        </div>

        <div class="modal-action">
            <button type="button" class="btn btn-primary" id="printInvoice">
                <i class="fas fa-print mr-2"></i>
                Print
            </button>
            <form method="dialog">
                <button class="btn btn-ghost">Close</button>
            </form>
        </div>
    </div>
</dialog>

@section Scripts {
    <script src="~/lib/handlebars/handlebars.min.js"></script>
    <script src="~/lib/html2canvas/html2canvas.min.js"></script>
    <script>
        "use strict";

        let invoicesData = [];

        // Function to show toast notification
        const showToast = (type, message) => {
            Toast.show(type, message, 3000);
        };

        // Function to load invoices
        const loadInvoices = () => {
            $.ajax({
                url: '/Invoice/GetInvoice',
                method: 'GET',
                success: (data) => {
                    console.log('Invoices loaded:', data);
                    invoicesData = data;
                    renderTable(data);
                },
                error: (xhr, status, error) => {
                    console.error('Error loading invoices:', error, xhr.responseText);
                    showToast('error', 'Failed to load invoices');
                }
            });
        };

        // Function to render table
        const renderTable = (data) => {
            const tableBody = document.getElementById('tableBody');

            if (!data || data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-12">
                            <div class="flex flex-col items-center gap-4">
                                <i class="fas fa-file-invoice fa-4x text-base-300"></i>
                                <div>
                                    <h3 class="font-bold text-lg">No invoices found</h3>
                                    <p class="text-base-content/70">Start by adding your first invoice</p>
                                </div>
                                <a href="@Url.Action("AddEdit", "Invoice")" class="btn btn-primary gap-2">
                                    <i class="fas fa-plus"></i>
                                    Add Invoice
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = data.map(invoice => `
                <tr class="hover transition-colors duration-200"
                    data-invoice="${invoice.invoiceNo || ''}"
                    data-filecode="${(invoice.fileCodeNo || '').toLowerCase()}"
                    data-client="${(invoice.clientName || '').toLowerCase()}">
                    <td>
                        <div class="badge badge-primary badge-lg font-mono">${invoice.invoiceNo || '-'}</div>
                    </td>
                    <td>
                        <span class="font-mono text-sm">${invoice.fileCodeNo || '-'}</span>
                    </td>
                    <td class="font-semibold">${invoice.clientName || '-'}</td>
                    <td>
                        <div class="badge badge-outline">${invoice.currency || '-'}</div>
                    </td>
                    <td class="font-bold text-success text-right">${parseFloat(invoice.netAmount || 0).toFixed(2)}</td>
                    <td>
                        <div class="flex gap-2 justify-center">
                            <a href="@Url.Action("AddEdit", "Invoice")?id=${invoice.id}" class="btn btn-ghost btn-sm text-primary hover:bg-primary/10" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="generateInvoice(${invoice.id})" class="btn btn-ghost btn-sm text-info hover:bg-info/10" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        };

        // Function to filter table
        const filterTable = () => {
            const invoiceNo = document.getElementById('searchField').value.toLowerCase();
            const fileCode = document.getElementById('searchFieldFileCode').value.toLowerCase();
            const client = document.getElementById('searchFieldClient').value.toLowerCase();

            const filtered = invoicesData.filter(invoice => {
                const matchInvoice = !invoiceNo || (invoice.invoiceNo || '').toLowerCase().includes(invoiceNo);
                const matchFileCode = !fileCode || (invoice.fileCodeNo || '').toLowerCase().includes(fileCode);
                const matchClient = !client || (invoice.clientName || '').toLowerCase().includes(client);

                return matchInvoice && matchFileCode && matchClient;
            });

            renderTable(filtered);
        };

        // Function to generate/view invoice
        window.generateInvoice = (id) => {
            console.log('Generating invoice for ID:', id);
            $.ajax({
                url: '/Invoice/GetInvoiceInfo',
                method: 'GET',
                data: { id: id },
                success: (data) => {
                    console.log('Raw data from controller:', data);
                    console.log('Invoice object:', data.invoice);
                    console.log('Invoice details:', data.invoiceDetail);
                    console.log('Username:', data.userName);
                    
                    data.invoice.fileCodeNo = data.invoice.fileCodeNo ? data.invoice.fileCodeNo.split('/')[1] : data.invoice.fileCodeNo;
                    console.log('After fileCodeNo split:', data.invoice.fileCodeNo);

                    var source = document.getElementById("entry-template").innerHTML;
                    console.log('Template source found:', source ? 'Yes' : 'No');
                    
                    var template = Handlebars.compile(source);
                    console.log('Template compiled');
                    
                    var result = template(data);
                    console.log('Template rendered');

                    document.getElementById('receiptTemplate').innerHTML = result;
                    document.getElementById('viewInvoice').showModal();
                },
                error: (xhr, status, error) => {
                    console.error('Error loading invoice info:', error, xhr.responseText);
                    showToast('error', 'Failed to load invoice');
                }
            });
        };

        // Document ready
        $(document).ready(function () {
            // Load invoices on page load
            loadInvoices();

            // Search filters
            document.getElementById('searchField').addEventListener('input', filterTable);
            document.getElementById('searchFieldFileCode').addEventListener('input', filterTable);
            document.getElementById('searchFieldClient').addEventListener('input', filterTable);

            // Print invoice button
            document.getElementById('printInvoice').addEventListener('click', function() {
                var printContent = document.getElementById('receiptTemplate').innerHTML;
                var printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            });
        });
    </script>
    <script id="entry-template" type="text/x-handlebars-template">
        <style>
            @@media print {
                body { margin: 0; padding: 20px; }
            }
            .invoice-container { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; color: #000; }
            .invoice-header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
            .company-info { font-size: 11px; line-height: 1.6; }
            .invoice-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; font-size: 13px; }
            .invoice-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            .invoice-table th { background: #f0f0f0; padding: 10px; text-align: left; border: 1px solid #000; font-size: 12px; }
            .invoice-table td { padding: 10px; border: 1px solid #000; font-size: 12px; }
            .invoice-table tfoot td { font-weight: bold; background: #f9f9f9; }
            .text-right { text-align: right; }
            .text-center { text-center; }
            .invoice-footer { margin-top: 30px; display: flex; justify-content: space-between; font-size: 11px; }
            .signature-section { text-align: right; margin-top: 40px; }
            strong { font-weight: 600; }
        </style>

        <div class="invoice-container">
            <div class="invoice-header">
                <div>
                    <h2 style="margin: 0 0 10px 0;">Peace International Tours & Travel</h2>
                    <div class="company-info">
                        <div>GPO Box: 9484, Lazimpat - 2, Kathmandu, Nepal</div>
                        <div>Tel: (977) 01 4444843/44/45</div>
                        <div>Email: peaceintl.mail@@gmail.com | mail@@peace-intl.com.np</div>
                        <div>Web: peace-intl.com | PAN: 302243385</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <h1 style="margin: 0; font-size: 28px;">INVOICE</h1>
                    <div style="margin-top: 10px; font-size: 13px;">
                        <div><strong>Invoice No:</strong> {{invoice.invoiceNo}}</div>
                        <div><strong>Date:</strong> {{chain "splitDate" "customDate" invoice.createdDate}}</div>
                    </div>
                </div>
            </div>

            <div class="invoice-details">
                <div>
                    <div><strong>To:</strong> {{invoice.dr}}</div>
                    <div style="margin-left: 20px;">{{invoice.address}}</div>
                    <div style="margin-top: 10px;"><strong>Client:</strong> {{invoice.clientName}} ({{invoice.pax}} PAX)</div>
                    <div><strong>Guide:</strong> {{invoice.guide}}</div>
                </div>
                <div>
                    <div><strong>Reference No:</strong> {{invoice.referenceNo}}</div>
                    <div><strong>File Code:</strong> {{invoice.fileCodeNo}}</div>
                    <div><strong>Currency:</strong> {{invoice.currency}}</div>
                    <div><strong>Vehicle:</strong> {{invoice.vehicle}}</div>
                </div>
            </div>

            <table class="invoice-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">SN</th>
                        <th>PARTICULARS</th>
                        <th style="width: 120px;" class="text-right">AMOUNT</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each invoiceDetail}}
                    <tr>
                        <td class="text-center">{{inc @@index}}</td>
                        <td>{{this.particulars}}</td>
                        <td class="text-right">{{distanceFixed this.amount}}</td>
                    </tr>
                    {{/each}}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-right">Total Due:</td>
                        <td class="text-right">{{distanceFixed invoice.totalDue}}</td>
                    </tr>
                    <tr>
                        <td colspan="2" class="text-right">Discount:</td>
                        <td class="text-right">{{distanceFixed invoice.discount}}</td>
                    </tr>
                    <tr>
                        <td colspan="2" class="text-right">Net Amount:</td>
                        <td class="text-right"><strong>{{distanceFixed invoice.netAmount}}</strong></td>
                    </tr>
                    <tr>
                        <td colspan="3"><strong>In Words:</strong> {{inWords invoice.netAmount}}</td>
                    </tr>
                </tfoot>
            </table>

            <div class="invoice-footer">
                <div>
                    <div>E. & O. E.</div>
                    <div>Prepared By: {{userName}}</div>
                </div>
                <div class="signature-section">
                    <div style="margin-bottom: 50px;">For: Peace International Tours & Travel (P) Ltd</div>
                    <div style="border-top: 1px solid #000; padding-top: 5px;">Authorized Signature</div>
                </div>
            </div>

            <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 10px; text-align: center;">
                <strong>IMPORTANT:</strong> If the Payment is to be made through Bank, transfer kindly made it directly at our A/C No. 01 04 21 7500056 at Nabil Bank, Kantipath, Kathmandu under advise to us.
            </div>
        </div>
    </script>
}
