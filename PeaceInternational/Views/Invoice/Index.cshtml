@{
    ViewData["Title"] = "Invoice";
}

<div class="animate-fade-in">
    <!-- Header with cleaner Daisy UI styling -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <div class="text-sm breadcrumbs">
                <ul>
                    <li>Management</li>
                    <li class="font-semibold">Invoices</li>
                </ul>
            </div>
            <h1 class="text-3xl font-bold">Invoice Management</h1>
        </div>
        <a asp-action="AddEdit" class="btn btn-primary gap-2">
            <i class="fas fa-plus"></i>
            New Invoice
        </a>
    </div>

    <!-- Search Filters -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                    <div class="input-group">
                        <span class="bg-base-200 px-4 flex items-center">
                            <i class="fas fa-hashtag"></i>
                        </span>
                        <input type="text" id="searchField" placeholder="Invoice No..." class="input input-bordered flex-1" />
                    </div>
                </div>
                <div class="form-control">
                    <div class="input-group">
                        <span class="bg-base-200 px-4 flex items-center">
                            <i class="fas fa-file-code"></i>
                        </span>
                        <input type="text" id="searchFieldFileCode" placeholder="File Code..." class="input input-bordered flex-1" />
                    </div>
                </div>
                <div class="form-control">
                    <div class="input-group">
                        <span class="bg-base-200 px-4 flex items-center">
                            <i class="fas fa-user"></i>
                        </span>
                        <input type="text" id="searchFieldClient" placeholder="Client Name..." class="input input-bordered flex-1" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Table -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full" id="invoiceTable">
                    <thead class="bg-primary text-primary-content">
                        <tr>
                            <th class="normal-case text-base">Invoice No.</th>
                            <th class="normal-case text-base">File Code</th>
                            <th class="normal-case text-base">Client Name</th>
                            <th class="normal-case text-base">Currency</th>
                            <th class="normal-case text-base text-right">Net Amount</th>
                            <th class="normal-case text-base text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="text-center py-12">
                                <div class="loading loading-spinner loading-lg text-primary"></div>
                                <p class="mt-4">Loading invoices...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- View/Print Invoice Modal -->
<dialog id="viewInvoice" class="modal">
    <div class="modal-box max-w-6xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
        </form>
        <h3 class="font-bold text-lg mb-4">Invoice</h3>

        <div id="invoiceBody" class="overflow-auto max-h-[70vh] bg-white p-4">
            <div id="receiptTemplate"></div>
        </div>

        <div class="modal-action">
            <button type="button" class="btn btn-error" id="printInvoice">
                <i class="fas fa-print mr-2"></i>
                Print
            </button>
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>

@section Scripts {
    <script src="~/lib/handlebars/handlebars.min.js"></script>
    <script src="~/lib/html2canvas/html2canvas.min.js"></script>
    <script>
        "use strict";

        let invoicesData = [];

        // Function to show toast notification
        const showToast = (type, message) => {
            Toast.show(type, message, 3000);
        };

        // Function to load invoices
        const loadInvoices = () => {
            $.ajax({
                url: 'Invoice/GetInvoice',
                method: 'GET',
                success: (data) => {
                    invoicesData = data;
                    renderTable(data);
                },
                error: () => {
                    showToast('error', 'Failed to load invoices');
                }
            });
        };

        // Function to render table
        const renderTable = (data) => {
            const tableBody = document.getElementById('tableBody');

            if (!data || data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-12">
                            <div class="flex flex-col items-center gap-4">
                                <i class="fas fa-file-invoice fa-4x text-base-300"></i>
                                <div>
                                    <h3 class="font-bold text-lg">No invoices found</h3>
                                    <p class="text-base-content/70">Start by adding your first invoice</p>
                                </div>
                                <a href="@Url.Action("AddEdit", "Invoice")" class="btn btn-primary gap-2">
                                    <i class="fas fa-plus"></i>
                                    Add Invoice
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = data.map(invoice => `
                <tr class="hover transition-colors duration-200"
                    data-invoice="${invoice.invoiceNo || ''}"
                    data-filecode="${(invoice.fileCodeNo || '').toLowerCase()}"
                    data-client="${(invoice.clientName || '').toLowerCase()}">
                    <td>
                        <div class="badge badge-primary badge-lg font-mono">${invoice.invoiceNo || '-'}</div>
                    </td>
                    <td>
                        <span class="font-mono text-sm">${invoice.fileCodeNo || '-'}</span>
                    </td>
                    <td class="font-semibold">${invoice.clientName || '-'}</td>
                    <td>
                        <div class="badge badge-outline">${invoice.currency || '-'}</div>
                    </td>
                    <td class="font-bold text-success text-right">${parseFloat(invoice.netAmount || 0).toFixed(2)}</td>
                    <td>
                        <div class="flex gap-2 justify-center">
                            <a href="@Url.Action("AddEdit", "Invoice")?id=${invoice.id}" class="btn btn-sm btn-info gap-2" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="generateInvoice(${invoice.id})" class="btn btn-sm btn-success gap-2" title="View">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        };

        // Function to filter table
        const filterTable = () => {
            const invoiceNo = document.getElementById('searchField').value.toLowerCase();
            const fileCode = document.getElementById('searchFieldFileCode').value.toLowerCase();
            const client = document.getElementById('searchFieldClient').value.toLowerCase();

            const filtered = invoicesData.filter(invoice => {
                const matchInvoice = !invoiceNo || (invoice.invoiceNo || '').toLowerCase().includes(invoiceNo);
                const matchFileCode = !fileCode || (invoice.fileCodeNo || '').toLowerCase().includes(fileCode);
                const matchClient = !client || (invoice.clientName || '').toLowerCase().includes(client);

                return matchInvoice && matchFileCode && matchClient;
            });

            renderTable(filtered);
        };

        // Function to generate/view invoice
        window.generateInvoice = (id) => {
            $.ajax({
                url: 'Invoice/GetInvoiceInfo',
                method: 'GET',
                data: { id: id },
                success: (data) => {
                    data.invoice.fileCodeNo = data.invoice.fileCodeNo ? data.invoice.fileCodeNo.split('/')[1] : data.invoice.fileCodeNo;

                    var source = document.getElementById("entry-template").innerHTML;
                    var template = Handlebars.compile(source);
                    var result = template(data);

                    document.getElementById('receiptTemplate').innerHTML = result;
                    document.getElementById('viewInvoice').showModal();
                },
                error: () => {
                    showToast('error', 'Failed to load invoice');
                }
            });
        };

        // Document ready
        $(document).ready(function () {
            // Load invoices on page load
            loadInvoices();

            // Search filters
            document.getElementById('searchField').addEventListener('input', filterTable);
            document.getElementById('searchFieldFileCode').addEventListener('input', filterTable);
            document.getElementById('searchFieldClient').addEventListener('input', filterTable);

            // Print invoice button
            document.getElementById('printInvoice').addEventListener('click', function() {
                html2canvas(document.getElementById("invoiceBody"), {
                    scale: 3
                }).then(function (canvas) {
                    var myImage = canvas.toDataURL("image/png");
                    var tWindow = window.open("");
                    tWindow.document.body.innerHTML = "<img id='Image' src='" + myImage + "' style='width:100%;'></img>";
                    tWindow.document.close();
                    tWindow.focus();
                    tWindow.print();
                });
            });
        });
    </script>
    <script id="entry-template" type="text/x-handlebars-template">
        <style>
            #page { border-collapse: collapse; border: 2px solid; font-family: Arial, Helvetica, sans-serif; }
            #page td { padding-top: 1px; margin: 0; font-size: 22px; border-right: 2px solid; }
            #page th { border-right: 2px solid; border-bottom: 2px solid; }
            #page tfoot { border-top: 2px solid; }
            .topRightInfo { padding-left: 6rem; }
            .topRightInfo h6 { margin-bottom: 1px; font-size:19px; }
            body h6 { font-size:24px; }
            span { font-weight: bold; }
        </style>

        <div class="row">
            <div class="col-md-8">
                <img src="~/img/logo2.jpg" style="max-width:100%; max-height:80%" />
            </div>
            <div class="col-md-4 topRightInfo">
                <h6>GPO Box: 9484</h6>
                <h6>Lazimpat - 2, Kathmandu, Nepal</h6>
                <h6>Tel: (977) 01 4444843/44/45</h6>
                <h6>Email: peaceintl.mail@@gmail.com</h6>
                <h6>&emsp;&emsp;&emsp;mail@@peace-intl.com.np </h6>
                <h6>Web: peace-intl.com </h6>
                <h6>PAN: 302243385 </h6>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <h6>Dr:&emsp;<span>{{invoice.dr}}</span></h6>
                <h6>&emsp;&emsp;&emsp;<span>{{invoice.address}}</span></h6>
                <h6>Ref No:&emsp;{{invoice.referenceNo}}</h6>
                <h6>Name:&emsp;<span>{{invoice.clientName}} X {{invoice.pax}} PAX</span></h6>
            </div>
            <div class="col-md-4" style="padding-left:6rem;">
                <h6>Date:&emsp;<span>{{chain "splitDate" "customDate" invoice.createdDate}}</span></h6>
                <h6>Invoice no:&emsp;{{invoice.invoiceNo}}</h6>
                <h6>File Code No:&emsp;{{invoice.fileCodeNo}}</h6>
                <h6>Currency:&emsp;<span>{{invoice.currency}}</span></h6>
            </div>
        </div>
        <br />
        <h6 class="text-center font-weight-bold">Your Account has been debited as per particulars given below:</h6>
        <div class="row flex-nowrap">
            <table class="table table-borderless ml-2 mr-2" id="page">
                <thead class="text-center thead-light">
                    <tr>
                        <th width="5%">SN.</th>
                        <th width="70%">PARTICULARS</th>
                        <th width="20%">AMOUNT</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each invoiceDetail}}
                    <tr>
                        <td height="40" align="center">{{inc @@index}}</td>
                        <td height="40">{{this.particulars}}</td>
                        <td height="40" class="text-right pr-5">{{distanceFixed this.amount}}</td>
                    </tr>
                    {{/each}}
                    {{#for invoiceDetail.length 18 1}}
                    <tr>
                        <td height="40"></td>
                        <td height="40"></td>
                        <td height="40"></td>
                    </tr>
                    {{/for}}
                </tbody>
                <tfoot>
                    <tr style="border-bottom:2px solid;">
                        <td colspan="2" align="right" class="font-weight-bold">Total Due:</td>
                        <td align="right" class="pr-5">{{distanceFixed invoice.totalDue}}</td>
                    </tr>
                    <tr style="border-bottom:2px solid;">
                        <td colspan="2" align="right" class="font-weight-bold">Discount:</td>
                        <td align="right" class="pr-5">{{distanceFixed invoice.discount}}</td>
                    </tr>
                    <tr style="border-bottom:2px solid;">
                        <td colspan="2" align="right" class="font-weight-bold">Net Amount:</td>
                        <td align="right" class="pr-5">{{distanceFixed invoice.netAmount}} </td>
                    </tr>
                    <tr>
                        <td colspan="3"><span>In Words:</span> {{inWords invoice.netAmount}}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="row">
            <div class="col-md-3">
                <h6>E. & O. E.</h6>
                <h6>ENCLOSURES: </h6>
                <h6>Prepared By: </h6>
                <h6>Checked By:</h6>
            </div>
            <div class="col-md-9">
                <h6 class="font-weight-bold float-right">For : Peace International Tours & Travel (P) Ltd</h6>
                <br /><br />
                <h6 class="float-right mr-5">{{userName}}</h6>
                <br /><br />
                <h6 class="border-top border-dark float-right">Authorized Signature: </h6>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 text-center">
                <br />
                <h6>
                    IMPORTANT : 1. If the Payment is to be made through Bank, transfer kindly made it directly either at our <br>A/C No. 01 04 21 7500056 at Nabil Bank, Kantipath, Kathmandu under advise to us.
                </h6>
            </div>
        </div>
    </script>
}
