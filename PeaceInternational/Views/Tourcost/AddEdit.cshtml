@model PeaceInternational.Web.Models.TourcostDTO

@{
    ViewData["Title"] = (Model?.Tourcost?.Id ?? 0) > 0 ? "Edit Tour Cost" : "Add Tour Cost";
}

<div class="animate-fade-in">
    <!-- Modern Header -->
    <div class="page-header mb-6">
        <div class="relative z-10 flex items-center gap-4">
            <a asp-action="Index" class="btn btn-circle btn-ghost text-white hover:bg-white/20 border-white/30">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                    <i class="fas fa-file-invoice-dollar text-2xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-white">@ViewData["Title"]</h1>
                    <p class="text-white/80 mt-1">Configure tour itinerary and pricing details</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <form asp-action="AddEdit" id="tourcostForm">
        <input type="hidden" asp-for="Tourcost.Id" />

        <!-- Top Section Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Days & Meal Plan Card -->
            <div class="section-modern">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                        <i class="fas fa-calendar-day text-lg text-primary"></i>
                    </div>
                    <h2 class="font-bold text-lg">Days & Meal Plan</h2>
                </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Number of Days</span>
                        </label>
                        <input asp-for="Tourcost.Days" class="input input-bordered" type="number" min="1" />
                    </div>
                    <div class="divider my-2"></div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Meal Type</span>
                        </label>
                        <div class="flex flex-col gap-2">
                            <label class="label cursor-pointer justify-start gap-3">
                                <input type="radio" asp-for="Tourcost.MealType" class="radio radio-primary" value="AP" />
                                <span class="label-text">AP (American Plan)</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-3">
                                <input type="radio" asp-for="Tourcost.MealType" class="radio radio-primary" value="MAP" />
                                <span class="label-text">MAP (Modified American Plan)</span>
                            </label>
                        </div>
                    </div>
            </div>

            <!-- Client & PAX Card -->
            <div class="section-modern">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                        <i class="fas fa-user text-lg text-primary"></i>
                    </div>
                    <h2 class="font-bold text-lg">Client Details</h2>
                </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Client Name <span class="text-error">*</span></span>
                        </label>
                        <input asp-for="Tourcost.ClientName" class="input input-bordered" required />
                    </div>
                    <div class="divider my-2"></div>
                    <label class="label">
                        <span class="label-text font-semibold">PAX Range</span>
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Min PAX <span class="text-error">*</span></span>
                            </label>
                            <input asp-for="Tourcost.MinPAX" class="input input-bordered input-sm" type="number" min="1" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Max PAX <span class="text-error">*</span></span>
                            </label>
                            <input asp-for="Tourcost.MaxPAX" class="input input-bordered input-sm" type="number" max="100" />
                        </div>
                    </div>
            </div>

            <!-- Guide Card -->
            <div class="section-modern">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                        <i class="fas fa-user-tie text-lg text-primary"></i>
                    </div>
                    <h2 class="font-bold text-lg">Guide</h2>
                </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Name</span>
                        </label>
                        <select asp-for="Tourcost.GuideId" class="select select-bordered" asp-items="ViewBag.Guide">
                            <option value="">Select Guide</option>
                        </select>
                    </div>
                    <div class="divider my-2"></div>
                    <div class="grid grid-cols-3 gap-1">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Half</span>
                            </label>
                            <input asp-for="Tourcost.GuideDaysHalfDay" class="input input-bordered input-sm" type="number" min="0" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Full</span>
                            </label>
                            <input asp-for="Tourcost.GuideDaysFullDay" class="input input-bordered input-sm" type="number" min="0" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Escort</span>
                            </label>
                            <input asp-for="Tourcost.GuideDaysEscort" class="input input-bordered input-sm" type="number" min="0" />
                        </div>
                    </div>
            </div>

            <!-- Additional Categories Card -->
            <div class="section-modern">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                        <i class="fas fa-tags text-lg text-primary"></i>
                    </div>
                    <h2 class="font-bold text-lg">Categories</h2>
                </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Category 1</span>
                            </label>
                            <input asp-for="Tourcost.Category1" class="input input-bordered input-sm" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Category 2</span>
                            </label>
                            <input asp-for="Tourcost.Category2" class="input input-bordered input-sm" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Category 3</span>
                            </label>
                            <input asp-for="Tourcost.Category3" class="input input-bordered input-sm" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Category 4</span>
                            </label>
                            <input asp-for="Tourcost.Category4" class="input input-bordered input-sm" />
                        </div>
                    </div>
            </div>
        </div>

        <!-- Tour Cost Details Collapse -->
        <div class="section-modern mb-6">
            <div class="collapse collapse-arrow bg-gradient-to-r from-primary/5 to-secondary/5 rounded-xl">
                <input type="checkbox" id="collapseToggle" />
                <div class="collapse-title text-xl font-bold">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                            <i class="fas fa-list-alt text-lg text-primary"></i>
                        </div>
                        <span>Tour Cost Details (Day by Day)</span>
                        <span class="badge badge-primary badge-lg" id="daysBadge">0 Days</span>
                    </div>
                </div>
                <div class="collapse-content">
                    <div class="pt-4">
                        <!-- Header Row -->
                        <div class="grid grid-cols-12 gap-2 mb-4 font-semibold text-sm text-base-content/70 bg-base-200 p-3 rounded-lg" id="tourCostDetailHeader">
                            <!-- Dynamically generated header -->
                        </div>
                        <!-- Detail Rows -->
                        <div id="tourCostDetailBody" class="space-y-2 max-h-[600px] overflow-y-auto pr-2">
                            <!-- Dynamically generated rows -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div class="section-modern mb-6">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-cog text-lg text-primary"></i>
                </div>
                <h2 class="font-bold text-lg">Additional Settings</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Comment -->
                    <div class="form-control md:col-span-3">
                        <label class="label">
                            <span class="label-text font-semibold">
                                <i class="fas fa-comment mr-2"></i>
                                Comment
                            </span>
                        </label>
                        <input asp-for="Tourcost.Comment" class="input input-bordered" />
                    </div>

                    <!-- Discount Accommodation -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Discount (Accommodation)</span>
                        </label>
                        <label class="input-group">
                            <input asp-for="Tourcost.DiscountAccomodation" class="input input-bordered flex-1" type="number" step="0.01" />
                            <span class="bg-base-300">%</span>
                        </label>
                    </div>

                    <!-- Discount Transportation -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Discount (Transportation)</span>
                        </label>
                        <label class="input-group">
                            <input asp-for="Tourcost.DiscountTransportation" class="input input-bordered flex-1" type="number" step="0.01" />
                            <span class="bg-base-300">%</span>
                        </label>
                    </div>

                    <!-- Luxury Checkbox -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Luxury Tour</span>
                        </label>
                        <label class="label cursor-pointer justify-start gap-3 border border-base-300 rounded-lg px-4 py-3">
                            <input asp-for="Tourcost.IsLuxury" class="checkbox checkbox-primary" type="checkbox" />
                            <span class="label-text">Mark as luxury tour</span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end gap-3 mt-6">
                    <a asp-action="Index" class="btn btn-ghost btn-lg">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg gap-2 shadow-lg hover:scale-105 transition-transform">
                        <i class="fas fa-save"></i>
                        @((Model?.Tourcost?.Id ?? 0) > 0 ? "Update Tour Cost" : "Save Tour Cost")
                    </button>
                </div>
        </div>
    </form>
</div>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script type="text/javascript">
        // Remove number input spinners
        const removeSpinners = () => {
            const style = document.createElement('style');
            style.textContent = `
                input::-webkit-outer-spin-button,
                input::-webkit-inner-spin-button {
                    -webkit-appearance: none;
                    margin: 0;
                }
                input[type=number] {
                    -moz-appearance: textfield;
                }
            `;
            document.head.appendChild(style);
        };
        removeSpinners();

        // Toast notification function
        const showToast = (type, message) => {
            Toast.show(type, message, 3000);
        };

        // Allow unchecking radio buttons with Ctrl+Click
        $('input[name="Tourcost.MealType"]').click(function (e) {
            if (e.ctrlKey) {
                $(this).prop('checked', false);
            }
        });

        // ========== OPTIMIZED VERSION ==========
        // Performance enhancements:
        // 1. Use DocumentFragment for batch DOM insertion
        // 2. Cache dropdown HTML generation
        // 3. Minimize DOM queries with caching
        // 4. Use native JavaScript where possible for speed

        // Cache dropdown HTML globally (generated once)
        const dropdownCache = {
            sector: '',
            hotelA: '',
            hotelB: '',
            hotelC: ''
        };

        // Build dropdown options once
        function buildDropdownCache() {
            const sector = @Html.Raw(Json.Serialize(ViewBag.Sector));
            const hotelCatA = @Html.Raw(Json.Serialize(ViewBag.HotelCatA));
            const hotelCatB = @Html.Raw(Json.Serialize(ViewBag.HotelCatB));
            const hotelCatC = @Html.Raw(Json.Serialize(ViewBag.HotelCatC));

            dropdownCache.sector = sector.map(v => `<option value="${v.value}">${v.text}</option>`).join('');
            dropdownCache.hotelA = hotelCatA.map(v => `<option value="${v.value}">${v.text}</option>`).join('');
            dropdownCache.hotelB = hotelCatB.map(v => `<option value="${v.value}">${v.text}</option>`).join('');
            dropdownCache.hotelC = hotelCatC.map(v => `<option value="${v.value}">${v.text}</option>`).join('');
        }

        // Create single row template (called once per row)
        function createRowHTML(index) {
            return `
                <div class="grid grid-cols-12 gap-2 bg-base-100 p-3 rounded-lg hover:bg-base-200 transition-colors" id="detailRow${index}">
                    <input type="hidden" id="TourcostDetail_${index}__Id" name="TourcostDetail[${index}].Id"/>
                    <div class="col-span-1">
                        <input id="TourcostDetail_${index}__Day" name="TourcostDetail[${index}].Day"
                               class="input input-bordered input-sm w-full font-semibold text-center bg-primary/10" value="D${index + 1}" readonly/>
                    </div>
                    <div class="col-span-2">
                        <select id="TourcostDetail_${index}__Sector1Id" name="TourcostDetail[${index}].Sector1Id"
                                class="select select-bordered select-sm w-full focus:select-primary">
                            <option value="">Select</option>
                            ${dropdownCache.sector}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <select id="TourcostDetail_${index}__Sector2Id" name="TourcostDetail[${index}].Sector2Id"
                                class="select select-bordered select-sm w-full focus:select-primary">
                            <option value="">Select</option>
                            ${dropdownCache.sector}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <select id="TourcostDetail_${index}__Sector3Id" name="TourcostDetail[${index}].Sector3Id"
                                class="select select-bordered select-sm w-full focus:select-primary">
                            <option value="">Select</option>
                            ${dropdownCache.sector}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <select id="TourcostDetail_${index}__HotelAId" name="TourcostDetail[${index}].HotelAId"
                                class="select select-bordered select-sm w-full focus:select-primary">
                            <option value="">Select</option>
                            ${dropdownCache.hotelA}
                        </select>
                    </div>
                    <div class="col-span-1">
                        <select id="TourcostDetail_${index}__HotelBId" name="TourcostDetail[${index}].HotelBId"
                                class="select select-bordered select-sm w-full focus:select-primary">
                            <option value="">Select</option>
                            ${dropdownCache.hotelB}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <select id="TourcostDetail_${index}__HotelCId" name="TourcostDetail[${index}].HotelCId"
                                class="select select-bordered select-sm w-full focus:select-primary">
                            <option value="">Select</option>
                            ${dropdownCache.hotelC}
                        </select>
                    </div>
                </div>
            `;
        }

        function setData() {
            const days = parseInt($('#Tourcost_Days').val()) || 0;

            // Update badge
            $('#daysBadge').text(`${days} Days`);

            // Build header
            const headerHTML = `
                <div class="col-span-1"><label class="label-text font-bold">Day</label></div>
                <div class="col-span-2"><label class="label-text font-bold">Sector 1</label></div>
                <div class="col-span-2"><label class="label-text font-bold">Sector 2</label></div>
                <div class="col-span-2"><label class="label-text font-bold">Sector 3</label></div>
                <div class="col-span-2"><label class="label-text font-bold">Hotel A</label></div>
                <div class="col-span-1"><label class="label-text font-bold">Hotel B</label></div>
                <div class="col-span-2" id="hotelC"><label class="label-text font-bold">Hotel C</label></div>
            `;
            $('#tourCostDetailHeader').html(headerHTML);

            // Build all rows efficiently using array join
            const rows = [];
            for (let i = 0; i < days; i++) {
                rows.push(createRowHTML(i));
            }

            // Single DOM update
            $('#tourCostDetailBody').html(rows.join(''));

            // Open the collapse when details are generated
            if (days > 0) {
                $('#collapseToggle').prop('checked', true);
                showToast('success', `Generated ${days} day(s) successfully`);
            }

            // Add validation rules for Sector1 (required)
            for (let i = 0; i < days; i++) {
                $(`#TourcostDetail_${i}__Sector1Id`).rules("add", "required");
            }

            // Handle categories efficiently
            handleCategories(days);
        }

        // Optimized category handling
        function handleCategories(days) {
            const categories = [
                { num: 1, field: '#Tourcost_Category1', headerDiv: '#catg1div', col: 8 },
                { num: 2, field: '#Tourcost_Category2', headerDiv: '#catg2div', col: 9 },
                { num: 3, field: '#Tourcost_Category3', headerDiv: '#catg3div', col: 10 },
                { num: 4, field: '#Tourcost_Category4', headerDiv: '#catg4div', col: 11 }
            ];

            categories.forEach(cat => {
                const value = $(cat.field).val();
                if (value) {
                    addCategoryColumn(cat.num, value, days);
                }
            });
        }

        // Add category column to header and rows
        function addCategoryColumn(catNum, catValue, days) {
            const catId = `catg${catNum}div`;

            // Add header column if not exists
            if (!$(`#${catId}`).length) {
                const insertAfter = catNum === 1 ? '#hotelC' : `#catg${catNum - 1}div`;
                $(`<div class="col-span-1" id="${catId}">
                    <label class="label-text font-bold">${catValue}
                        <button type="button" class='btn btn-ghost btn-xs text-error ml-2' id="rmCat${catNum}">
                            <i class="fas fa-times"></i>
                        </button>
                    </label>
                </div>`).insertAfter(insertAfter);

                // Attach remove handler
                $(`#rmCat${catNum}`).on('click', function() {
                    removeCategoryColumn(catNum);
                });
            }

            // Add input fields to each row
            const numDays = days || $('#tourCostDetailBody').find('.grid').length;
            for (let i = 0; i < numDays; i++) {
                const existingInput = $(`#TourcostDetail_${i}__Category${catNum}Cost`);
                if (!existingInput.length) {
                    const inputHTML = `<div class="col-span-1">
                        <input type="text"
                               id="TourcostDetail_${i}__Category${catNum}Cost"
                               name="TourcostDetail[${i}].Category${catNum}Cost"
                               class="input input-bordered input-sm w-full focus:input-primary"
                               placeholder="0"/>
                    </div>`;
                    $(`#detailRow${i}`).append(inputHTML);
                }
            }
        }

        // Remove category column
        function removeCategoryColumn(catNum) {
            $(`#catg${catNum}div`).remove();
            $(`#Tourcost_Category${catNum}`).val('');

            // Remove inputs from all rows
            const rowLength = $('#tourCostDetailBody').find('.grid').length;
            for (let i = 0; i < rowLength; i++) {
                $(`#TourcostDetail_${i}__Category${catNum}Cost`).parent().remove();
            }

            showToast('info', `Category ${catNum} removed`);
        }

        // Debounce helper for better performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        $(document).ready(function () {
            // Build dropdown cache on page load
            buildDropdownCache();
            var previousValue = [];
            var rowLength;

            var data = @Html.Raw(Json.Serialize(Model));

            if (!$('#Tourcost_DiscountAccomodation').val()) {
                $('#Tourcost_DiscountAccomodation').val(0);
            }

            if (!$('#Tourcost_DiscountTransportation').val()) {
                $('#Tourcost_DiscountTransportation').val(0);
            }

            if (data.tourcostDetail != null) {
                setData();

                for (let i = 0; i < data.tourcost.days; i++) {
                    $(`#TourcostDetail_${i}__Id`).val(data.tourcostDetail[i].id);
                    $(`#TourcostDetail_${i}__Day`).val(data.tourcostDetail[i].day);
                    $(`#TourcostDetail_${i}__Sector1Id`).val(data.tourcostDetail[i].sector1Id);
                    $(`#TourcostDetail_${i}__Sector2Id`).val(data.tourcostDetail[i].sector2Id);
                    $(`#TourcostDetail_${i}__Sector3Id`).val(data.tourcostDetail[i].sector3Id);
                    $(`#TourcostDetail_${i}__HotelAId`).val(data.tourcostDetail[i].hotelAId);
                    $(`#TourcostDetail_${i}__HotelBId`).val(data.tourcostDetail[i].hotelBId);
                    $(`#TourcostDetail_${i}__HotelCId`).val(data.tourcostDetail[i].hotelCId);
                    $(`#TourcostDetail_${i}__Category1Cost`).val(data.tourcostDetail[i].category1Cost);
                    $(`#TourcostDetail_${i}__Category2Cost`).val(data.tourcostDetail[i].category2Cost);
                    $(`#TourcostDetail_${i}__Category3Cost`).val(data.tourcostDetail[i].category3Cost);
                    $(`#TourcostDetail_${i}__Category4Cost`).val(data.tourcostDetail[i].category4Cost);
                }
            }

            $("#Tourcost_Days").on('focus', function () {
                previousValue = [];
                rowLength = $('#Tourcost_Days').val();
                for (let i = 0; i < rowLength; i++) {
                    previousValue.push({
                        Id: $(`#TourcostDetail_${i}__Id`).val(),
                        Sector1: $(`#TourcostDetail_${i}__Sector1Id`).val(),
                        Sector2: $(`#TourcostDetail_${i}__Sector2Id`).val(),
                        Sector3: $(`#TourcostDetail_${i}__Sector3Id`).val(),
                        HotelA: $(`#TourcostDetail_${i}__HotelAId`).val(),
                        HotelB: $(`#TourcostDetail_${i}__HotelBId`).val(),
                        HotelC: $(`#TourcostDetail_${i}__HotelCId`).val(),
                        Category1: $(`#TourcostDetail_${i}__Category1Cost`).val(),
                        Category2: $(`#TourcostDetail_${i}__Category2Cost`).val(),
                        Category3: $(`#TourcostDetail_${i}__Category3Cost`).val(),
                        Category4: $(`#TourcostDetail_${i}__Category4Cost`).val()
                    });
                }
            }).change(function () {
                setData();

                for (let i = 0; i < rowLength; i++) {
                    previousValue[i].Id ? $(`#TourcostDetail_${i}__Id`).val(previousValue[i].Id) : previousValue[i].Id;
                    previousValue[i].Sector1 ? $(`#TourcostDetail_${i}__Sector1Id`).val(previousValue[i].Sector1) : previousValue[i].Sector1;
                    previousValue[i].Sector2 ? $(`#TourcostDetail_${i}__Sector2Id`).val(previousValue[i].Sector2) : previousValue[i].Sector2;
                    previousValue[i].Sector3 ? $(`#TourcostDetail_${i}__Sector3Id`).val(previousValue[i].Sector3) : previousValue[i].Sector3;
                    previousValue[i].HotelA ? $(`#TourcostDetail_${i}__HotelAId`).val(previousValue[i].HotelA) : previousValue[i].HotelA;
                    previousValue[i].HotelB ? $(`#TourcostDetail_${i}__HotelBId`).val(previousValue[i].HotelB) : previousValue[i].HotelB;
                    previousValue[i].HotelC ? $(`#TourcostDetail_${i}__HotelCId`).val(previousValue[i].HotelC) : previousValue[i].HotelC;
                    previousValue[i].Category1 ? $(`#TourcostDetail_${i}__Category1Cost`).val(previousValue[i].Category1) : previousValue[i].Category1;
                    previousValue[i].Category2 ? $(`#TourcostDetail_${i}__Category2Cost`).val(previousValue[i].Category2) : previousValue[i].Category2;
                    previousValue[i].Category3 ? $(`#TourcostDetail_${i}__Category3Cost`).val(previousValue[i].Category3) : previousValue[i].Category3;
                    previousValue[i].Category4 ? $(`#TourcostDetail_${i}__Category4Cost`).val(previousValue[i].Category4) : previousValue[i].Category4;
                }
            });

            // Optimized category change handlers with debouncing
            const handleCategoryChange = debounce(function(catNum) {
                const value = $(`#Tourcost_Category${catNum}`).val();
                if (!value) return;

                const days = parseInt($('#Tourcost_Days').val());
                if (!days || days === 0) {
                    showToast('warning', 'Please set number of days first');
                    return;
                }

                // Add the category column
                addCategoryColumn(catNum, value, days);

                // Ask if same value for all days
                const isSameValue = confirm(`Do you want to use the same ${value} rate for all days?`);
                if (isSameValue) {
                    const cost = prompt(`Enter cost for ${value}`) || 0;
                    for (let i = 0; i < days; i++) {
                        $(`#TourcostDetail_${i}__Category${catNum}Cost`).val(cost);
                    }
                }
            }, 300);

            // Category validation and change handlers
            $('#Tourcost_Category1').on('change', () => handleCategoryChange(1));
            $('#Tourcost_Category2').on('change', function() {
                if (!$('#Tourcost_Category1').val()) {
                    $(this).val('');
                    showToast('error', 'Please fill Category 1 first');
                    return;
                }
                handleCategoryChange(2);
            });
            $('#Tourcost_Category3').on('change', function() {
                if (!$('#Tourcost_Category2').val()) {
                    $(this).val('');
                    showToast('error', 'Please fill Category 2 first');
                    return;
                }
                handleCategoryChange(3);
            });
            $('#Tourcost_Category4').on('change', function() {
                if (!$('#Tourcost_Category3').val()) {
                    $(this).val('');
                    showToast('error', 'Please fill Category 3 first');
                    return;
                }
                handleCategoryChange(4);
            });
        });
    </script>
}
