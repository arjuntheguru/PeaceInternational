@model PeaceInternational.Core.Entity.Tourcost

@{
    ViewData["Title"] = "Tourcost";
}

<style type="text/css">
    @@media print { 
        body { margin: 0; padding: 20px; }
        .page-header, .fixed, .btn, .toast, #toastContainer, .loader, #loader { display: none !important; }
        .card { box-shadow: none; border: 1px solid #e5e7eb; }
    }
    #tourcostTemplate .border-secondary, #pppTemplate .border-secondary { border-color: #4A7C59 !important; }
    #tourcostTemplate .h5, #tourcostTemplate h5, #pppTemplate .h5, #pppTemplate h5 { 
        font-size: 1.25rem; 
        font-weight: 700; 
        color: #4A7C59; 
        margin: 1rem 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    #tourcostTemplate .h6, #tourcostTemplate h6, #pppTemplate .h6, #pppTemplate h6 { 
        font-size: 1.1rem; 
        font-weight: 600; 
        color: #1f2937; 
    }
    #pppTemplate .card-body p.h5 { font-size: 0.95rem; font-weight: 500; }
    #pppTemplate .form-row { display: flex; justify-content: flex-end; gap: 2rem; margin-top: 1rem; }
    #pppTemplate .form-row .col-md-4 { width: auto; }
    #pppTemplate .form-row p.h5 { font-size: 0.9rem; font-weight: 500; margin: 0.25rem 0; float: none !important; }
    #tourcostTemplate .text-monospace, #pppTemplate .text-monospace { font-family: 'Courier New', monospace; }
    #tourcostTemplate .font-weight-bold, #pppTemplate .font-weight-bold { font-weight: 700; color: #4A7C59; }
    #pppTemplate .card { background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
    #pppTemplate .card-body p { font-size: 1rem; color: #1f2937; }
    #tourcostTemplate table, #pppTemplate table { width: 100%; border-collapse: collapse; }
    #tourcostTemplate table td, #tourcostTemplate table th,
    #pppTemplate table td, #pppTemplate table th { 
        padding: 8px; 
        border: 1px solid #e5e7eb; 
        color: #1f2937;
    }
    #tourcostTemplate table th, #pppTemplate table th { 
        background-color: #4A7C59; 
        color: white; 
        font-weight: 600;
    }
    #tourcostTemplate .border, #pppTemplate .border { border: 2px solid #4A7C59; }
    #tourcostTemplate h6, #pppTemplate h6 { color: #1f2937; margin: 8px 0; }
    #tourcostTemplate label, #pppTemplate label { color: #1f2937; }
    .loader { 
        position: fixed; 
        left: 50%; 
        top: 50%; 
        transform: translate(-50%, -50%); 
        z-index: 9999;
        width: 50px;
        height: 50px;
        border: 5px solid #4A7C59; 
        border-top-color: transparent; 
        border-radius: 50%; 
        animation: spin 1s linear infinite;
    }
    @@keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="animate-fade-in">
    <!-- Page Header -->
    <div class="page-header mb-6">
        <div class="flex items-center gap-4">
            <a href="@Url.Action("Index")" class="btn btn-circle btn-ghost">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-file-invoice-dollar text-2xl text-primary"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-base-content">Tour Cost Details</h1>
                    <p class="text-base-content/70 mt-1">View and print tour cost breakdown</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tour Cost Content -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-primary/20">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-table text-xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold text-base-content tracking-tight">Tour Cost Breakdown</h2>
            </div>
            <div id="tourcostTemplate" class="overflow-x-auto"></div>
        </div>
    </div>

    <!-- PPP Content -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-primary/20">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-calculator text-xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold text-base-content tracking-tight">Per Person Pricing</h2>
            </div>
            <div id="backPage">
                <div id="pppTemplate" class="overflow-x-auto"></div>
                <div class="mt-6">
                    <img src="~/img/logo2.jpg" class="max-w-xs" />
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="fixed bottom-6 right-6 flex flex-col gap-3 z-50">
    <div class="tooltip tooltip-left" data-tip="Print Tour Cost">
        <button class="btn btn-circle btn-primary btn-lg shadow-lg" id="printTourcost">
            <i class="fas fa-print text-xl"></i>
        </button>
    </div>
    <div class="tooltip tooltip-left" data-tip="Print PPP Cost">
        <button class="btn btn-circle btn-accent btn-lg shadow-lg" id="printPPPcost">
            <i class="fas fa-print text-xl"></i>
        </button>
    </div>
</div>

<!-- Loader -->
<div id="loader"></div>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/ppp-template.js"></script>
    <script src="~/js/tourcost-template.js"></script>
    <script type="text/javascript">
        try {
        var data =  @Html.Raw(Json.Serialize(Model));
        console.log('=== TOUR COST DATA ===');
        console.log('Full data object:', data);
        console.log('Client Name:', data?.clientName);
        console.log('Tour Cost Details:', data?.tourcostDetail);
        console.log('Guide:', data?.guide);
        console.log('======================');
        
        if (!data) {
            console.error('ERROR: No data available');
            document.getElementById('tourcostTemplate').innerHTML = '<div class="alert alert-error"><span>No tour cost data available</span></div>';
        }
        
        if (!data.tourcostDetail || data.tourcostDetail.length === 0) {
            console.error('ERROR: No tour cost details found');
            document.getElementById('tourcostTemplate').innerHTML = '<div class="alert alert-warning"><span>No tour cost details found for this tour</span></div>';
        }

        // Tooltips removed - using DaisyUI tooltips if needed

        data.guideTotalCost = 0;
        data.PAX = 0;
        if (data.minPAX == data.maxPAX) {
            data.PAX = data.minPAX
        }

        if (data.guideId != null) {

            if (data.guideDaysHalfDay != null) {
                data.guideTotalCost += data.guide.halfDayRate * data.guideDaysHalfDay;
            }

            if (data.guideDaysFullDay != null) {
                data.guideTotalCost += data.guide.fullDayRate * data.guideDaysFullDay;
            }

            if (data.guideDaysEscort != null) {
                data.guideTotalCost += data.guide.overNight * data.guideDaysEscort;
            }
        }

        data.image = "img/logo2.jpg";
        data.isLuxury = data.isLuxury ? "Yes" : "No";
        data.t1total = 0;
        data.t2total = 0;
        data.t3total = 0;
        data.t4total = 0;
        data.t5total = 0;
        data.t6total = 0;
        data.catAXTotal = 0;
        data.catAXXTotal = 0;
        data.catAETotal = 0;
        data.catBXTotal = 0;
        data.catBXXTotal = 0;
        data.catBETotal = 0;
        data.catCXTotal = 0;
        data.catCXXTotal = 0;
        data.catCETotal = 0;
        data.category1Total = 0;
        data.category2Total = 0;
        data.category3Total = 0;
        data.category4Total = 0;

        $.each(data.tourcostDetail, function (idx, item) {
            // Skip if sector data is missing
            if (!item.sector1 || !item.sector1.sectorTransport || item.sector1.sectorTransport.length < 6) {
                console.warn('Missing sector transport data for item:', idx);
                item.t1cost = 0;
                item.t2cost = 0;
                item.t3cost = 0;
                item.t4cost = 0;
                item.t5cost = 0;
                item.t6cost = 0;
                return;
            }

            if (item.sector2 && item.sector3 && item.sector2.sectorTransport && item.sector3.sectorTransport) {
                item.t1cost = item.sector1.sectorTransport[0].cost + item.sector2.sectorTransport[0].cost + item.sector3.sectorTransport[0].cost;
                data.t1total += item.t1cost;
                item.t2cost = item.sector1.sectorTransport[1].cost + item.sector2.sectorTransport[1].cost + item.sector3.sectorTransport[1].cost;
                data.t2total += item.t2cost;
                item.t3cost = item.sector1.sectorTransport[2].cost + item.sector2.sectorTransport[2].cost + item.sector3.sectorTransport[2].cost;
                data.t3total += item.t3cost;
                item.t4cost = item.sector1.sectorTransport[3].cost + item.sector2.sectorTransport[3].cost + item.sector3.sectorTransport[3].cost;
                data.t4total += item.t4cost;
                item.t5cost = item.sector1.sectorTransport[4].cost + item.sector2.sectorTransport[4].cost + item.sector3.sectorTransport[4].cost;
                data.t5total += item.t5cost;
                item.t6cost = item.sector1.sectorTransport[5].cost + item.sector2.sectorTransport[5].cost + item.sector3.sectorTransport[5].cost;
                data.t6total += item.t6cost;
                item.sector2.code = `/${item.sector2.code}`
                item.sector3.code = `/${item.sector3.code}`
            }
            else if (item.sector2 && item.sector2.sectorTransport) {
                item.t1cost = item.sector1.sectorTransport[0].cost + item.sector2.sectorTransport[0].cost;
                data.t1total += item.t1cost;
                item.t2cost = item.sector1.sectorTransport[1].cost + item.sector2.sectorTransport[1].cost;
                data.t2total += item.t2cost;
                item.t3cost = item.sector1.sectorTransport[2].cost + item.sector2.sectorTransport[2].cost;
                data.t3total += item.t3cost;
                item.t4cost = item.sector1.sectorTransport[3].cost + item.sector2.sectorTransport[3].cost;
                data.t4total += item.t4cost;
                item.t5cost = item.sector1.sectorTransport[4].cost + item.sector2.sectorTransport[4].cost;
                data.t5total += item.t5cost;
                item.t6cost = item.sector1.sectorTransport[5].cost + item.sector2.sectorTransport[5].cost;
                data.t6total += item.t6cost;
                item.sector2.code = `/${item.sector2.code}`
            }
            else {
                item.t1cost = item.sector1.sectorTransport[0].cost;
                data.t1total += item.t1cost;
                item.t2cost = item.sector1.sectorTransport[1].cost;
                data.t2total += item.t2cost;
                item.t3cost = item.sector1.sectorTransport[2].cost;
                data.t3total += item.t3cost;
                item.t4cost = item.sector1.sectorTransport[3].cost;
                data.t4total += item.t4cost;
                item.t5cost = item.sector1.sectorTransport[4].cost;
                data.t5total += item.t5cost;
                item.t6cost = item.sector1.sectorTransport[5].cost;
                data.t6total += item.t6cost;
            };

            if (item.hotelA && item.hotelA.hotelRoomRate) {

                if (data.mealType == 'AP') {

                    item.hotelA.hotelRoomRate.singleBed += item.hotelA.hotelRoomRate.ap;
                    item.hotelA.hotelRoomRate.doubleBed += item.hotelA.hotelRoomRate.ap * 2;
                    item.hotelA.hotelRoomRate.extraBed += item.hotelA.hotelRoomRate.ap * 3;
                }
                else if (data.mealType == 'MAP') {
                    item.hotelA.hotelRoomRate.singleBed += item.hotelA.hotelRoomRate.map;
                    item.hotelA.hotelRoomRate.doubleBed += item.hotelA.hotelRoomRate.map * 2;
                    item.hotelA.hotelRoomRate.extraBed += item.hotelA.hotelRoomRate.map * 3;
                }

                 data.catAXTotal += item.hotelA.hotelRoomRate.singleBed;
                data.catAXXTotal += item.hotelA.hotelRoomRate.doubleBed;
                data.catAETotal += item.hotelA.hotelRoomRate.extraBed;
            }

            if (item.hotelB && item.hotelB.hotelRoomRate) {

                if (data.mealType == 'AP') {
                    item.hotelB.hotelRoomRate.singleBed += item.hotelB.hotelRoomRate.ap;
                    item.hotelB.hotelRoomRate.doubleBed += item.hotelB.hotelRoomRate.ap * 2;
                    item.hotelB.hotelRoomRate.extraBed += item.hotelB.hotelRoomRate.ap * 3;
                }
                else if (data.mealType == 'MAP') {

                    item.hotelB.hotelRoomRate.singleBed += item.hotelB.hotelRoomRate.map;
                    item.hotelB.hotelRoomRate.doubleBed += item.hotelB.hotelRoomRate.map * 2;
                    item.hotelB.hotelRoomRate.extraBed += item.hotelB.hotelRoomRate.map * 3;
                }

                data.catBXTotal += item.hotelB.hotelRoomRate.singleBed;
                data.catBXXTotal += item.hotelB.hotelRoomRate.doubleBed;
                data.catBETotal += item.hotelB.hotelRoomRate.extraBed;
            }

            if (item.hotelC && item.hotelC.hotelRoomRate) {

                if (data.mealType == 'AP') {
                    item.hotelC.hotelRoomRate.singleBed += item.hotelC.hotelRoomRate.ap;
                    item.hotelC.hotelRoomRate.doubleBed += item.hotelC.hotelRoomRate.ap * 2;
                    item.hotelC.hotelRoomRate.extraBed += item.hotelC.hotelRoomRate.ap * 3;
                }
                else if (data.mealType == 'MAP') {
                    item.hotelC.hotelRoomRate.singleBed += item.hotelC.hotelRoomRate.map;
                    item.hotelC.hotelRoomRate.doubleBed += item.hotelC.hotelRoomRate.map * 2;
                    item.hotelC.hotelRoomRate.extraBed += item.hotelC.hotelRoomRate.map * 3;
                }

                data.catCXTotal += item.hotelC.hotelRoomRate.singleBed;
                data.catCXXTotal += item.hotelC.hotelRoomRate.doubleBed;
                data.catCETotal += item.hotelC.hotelRoomRate.extraBed;
            }

            data.category1Total += item.category1Cost;
            data.category2Total += item.category2Cost;
            data.category3Total += item.category3Cost;
            data.category4Total += item.category4Cost;

        });

   
        // Render templates
        var result = Handlebars.templates['tourcost-template'](data);
        $('#tourcostTemplate').html(result);
        
        var result1 = Handlebars.templates['ppp-template'](data);
        $('#pppTemplate').html(result1);


        if ($('#hotelTable tbody td:nth-child(4)').length > 0) {
            for (let i = 0; i < 3; i++) {

                let singleBed = parseFloat($('#hotelTable tbody td:nth-child(4)')[i].innerHTML);
                let halfTwin = parseFloat($('#hotelTable tbody td:nth-child(3)')[i].innerHTML);
                let singleSupplement = (singleBed - halfTwin).toFixed(2);
                $('#hotelTable tbody td:nth-child(5)')[i].innerHTML = singleSupplement;
            }
        }

        let lowerTransportIterator = 0
        let upperTransportIterator = 0

        switch (data.lowerTransport) {
            case "T1":
                break;

            case "T2":
                lowerTransportIterator = 1;
                break;

            case "T3":
                lowerTransportIterator = 2;
                break;

            case "T4":
                lowerTransportIterator = 3;
                break;

            case "T5":
                lowerTransportIterator = 4;
                break;

            case "T6":
                lowerTransportIterator = 5;
                break;
        }

        switch (data.upperTransport) {
            case "T1":
                upperTransportIterator = 5;
                break;

            case "T2":
                upperTransportIterator = 4;
                break;

            case "T3":
                upperTransportIterator = 3;
                break;

            case "T4":
                upperTransportIterator = 2;
                break;

            case "T5":
                upperTransportIterator = 1;
                break;

            case "T6":
                break;
        }

        console.log(lowerTransportIterator, upperTransportIterator);

        for (let i = 0; i < upperTransportIterator; i++) {
            $(`#itcTable tbody tr:eq(${5 - i})`).remove();
        }

        for (let i = 0; i < lowerTransportIterator; i++) {
            $('#itcTable tbody tr:eq(0)').remove()
        }

        let flag = 0;
        data.category1 != null ? flag++ : '';
        data.category2 != null ? flag++ : '';
        data.category3 != null ? flag++ : '';
        data.category4 != null ? flag++ : '';

        console.log(flag);

        //For first calc
        for (let i = 0; i < 16; i = i + 3) {

            let val =   parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(2)`)[0].innerText) +
                parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(3)`)[0].innerText) +
                parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(4)`)[0].innerText);

            val += flag >= 1 ? parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(5)`)[0].innerText) : 0;
            val += flag >= 2 ? parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(6)`)[0].innerText) : 0;
            val += flag >= 3 ? parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(7)`)[0].innerText) : 0;
            val += flag >= 4 ? parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(8)`)[0].innerText) : 0;

            $(`#pppTable tr:nth-child(${i + 1}) td:nth-child(${flag + 5})`)[0].innerText = val


            //$(`#pppTable tr:nth-child(${i + 1}) td:nth-child(${flag + 6})`)[0].innerText = (1.13 * val).toFixed(2);
        };

        //For second calc
        for (let i = 1; i < 17; i = i + 3) {

            let val = parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(2)`)[0].innerText) +
                parseFloat($(`#pppTable tr:nth-child(${i + 1}) td:nth-child(1)`)[0].innerText) +
                parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(4)`)[0].innerText);

            val += flag >= 1 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(5)`)[0].innerText) : 0;
            val += flag >= 2 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(6)`)[0].innerText) : 0;
            val += flag >= 3 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(7)`)[0].innerText) : 0;
            val += flag >= 4 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(8)`)[0].innerText) : 0;


            $(`#pppTable tr:nth-child(${i + 1}) td:nth-child(2)`)[0].innerText = val;

            //$(`#pppTable tr:nth-child(${i + 1}) td:nth-child(3)`)[0].innerText = (1.13 * val).toFixed(2);
        };

        //For third calc
        for (let i = 1; i < 18; i = i + 3) {

            let val = parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(2)`)[0].innerText) +
                parseFloat($(`#pppTable tr:nth-child(${i + 2}) td:nth-child(1)`)[0].innerText) +
                parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(4)`)[0].innerText);

            val += flag >= 1 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(5)`)[0].innerText) : 0;
            val += flag >= 2 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(6)`)[0].innerText) : 0;
            val += flag >= 3 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(7)`)[0].innerText) : 0;
            val += flag >= 4 ? parseFloat($(`#pppTable tr:nth-child(${i}) td:nth-child(8)`)[0].innerText) : 0;

            $(`#pppTable tr:nth-child(${i + 2}) td:nth-child(2)`)[0].innerText = val;


            //$(`#pppTable tr:nth-child(${i + 2}) td:nth-child(3)`)[0].innerText = (1.13 * val).toFixed(2);
        };

          for (let i = 0; i < upperTransportIterator * 3; i++) {
            $(`#pppTable tbody tr:eq(${17 - i})`).remove()
        }

        for (let i = 0; i < lowerTransportIterator * 3; i++) {
            $('#pppTable tbody tr:eq(0)').remove()
        }

        $('#printTourcost').off('click').on('click', function () {
            window.print();
        });

        $('#printPPPcost').off('click').on('click', function () {
            window.print();
        });
        
        } catch(error) {
            console.error('ERROR in script:', error);
            $('#tourcostTemplate').html('<div class="alert alert-error"><span>Error loading tour cost: ' + error.message + '</span></div>');
        }
    </script>
}
